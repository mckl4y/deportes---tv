<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AGUS SPORTS | Omnideportivo</title>
    <style>
        :root { --accent: #3b82f6; --bg-deep: #0f172a; --bg-card: #1e293b; --text: #f8fafc; --live: #ef4444; }
        body { font-family: 'Inter', sans-serif; background: var(--bg-deep); color: var(--text); margin: 0; padding-top: 190px; }
        
        header { 
            background: rgba(15, 23, 42, 0.95); backdrop-filter: blur(10px);
            padding: 15px 30px; position: fixed; top: 0; width: 100%; 
            z-index: 2000; border-bottom: 2px solid var(--accent);
            display: flex; justify-content: space-between; align-items: center; box-sizing: border-box;
        }

        .nav-main {
            position: fixed; top: 70px; width: 100%; background: #1e293b;
            padding: 10px 0; z-index: 1900; display: flex; justify-content: center; gap: 15px; border-bottom: 1px solid #334155;
        }

        .nav-btn { background: none; border: 1px solid var(--accent); color: white; padding: 6px 15px; border-radius: 20px; cursor: pointer; font-size: 12px; font-weight: bold; }
        .nav-btn.active { background: var(--accent); }

        .controls {
            position: fixed; top: 116px; width: 100%; background: #0f172a;
            padding: 12px 0; z-index: 1800; display: flex; justify-content: center; gap: 8px; flex-wrap: wrap;
        }

        select { background: #1e293b; color: white; border: 1px solid #475569; padding: 8px; border-radius: 6px; font-weight: bold; font-size: 13px; }
        
        .container { max-width: 1000px; margin: 0 auto; padding: 15px; }

        .cat-tag { background: var(--accent); color: white; padding: 4px 10px; border-radius: 4px; font-size: 10px; font-weight: bold; margin-bottom: 10px; display: inline-block; }

        .match-card {
            background: var(--bg-card); border-radius: 12px; margin-bottom: 10px;
            padding: 15px; display: grid; grid-template-columns: 100px 1fr 200px;
            align-items: center; border: 1px solid #334155;
        }

        .teams { display: grid; grid-template-columns: 1fr 40px 1fr; align-items: center; text-align: center; font-weight: bold; }
        .teams img { width: 25px; height: 25px; object-fit: contain; margin-bottom: 4px; }

        .channel-selector {
            background: #0f172a; color: #22c55e; border: 1px solid #22c55e;
            padding: 8px; border-radius: 6px; font-size: 11px; width: 100%; cursor: pointer; font-weight: 800;
        }

        #cine { position: fixed; top:0; left:0; width:100%; height:100%; background:black; z-index:4000; display:none; flex-direction:column; }
        iframe { flex-grow:1; border:none; }

        @keyframes blink { 50% { opacity: 0.3; } }
        .live-pulse { color: var(--live); animation: blink 1s infinite; font-weight: 900; }

        @media (max-width: 750px) { 
            body { padding-top: 280px; }
            .match-card { grid-template-columns: 1fr; text-align: center; }
            .controls { top: 115px; }
        }
    </style>
</head>
<body>

<header>
    <div style="font-size: 18px; font-weight: 900;">AGUS <span style="color:var(--accent)">TOTAL SPORTS</span></div>
    <div id="fecha-local" style="font-size: 11px; opacity: 0.7;"></div>
</header>

<div class="nav-main">
    <button class="nav-btn active" onclick="showView('eventos', this)">üìÖ EVENTOS HOY</button>
    <button class="nav-btn" onclick="showView('canales', this)">üì∫ CANALES DIRECTOS</button>
</div>

<div class="controls" id="event-controls">
    <select id="sel-cat" onchange="actualizarSubCategorias()">
        <option value="acuaticos">üíß Acu√°ticos</option>
        <option value="atletismo">üèÉ Atletismo</option>
        <option value="gimnasia">ü§∏ Gimnasia</option>
        <option value="ciclismo">üö≤ Ciclismo</option>
        <option value="equipo">üë• Deportes Equipo</option>
        <option value="combate">ü•ä Combate</option>
        <option value="raqueta">üéæ Raqueta</option>
        <option value="motor">üèéÔ∏è Motor</option>
        <option value="invierno">‚ùÑÔ∏è Invierno</option>
        <option value="precision">üéØ Precisi√≥n</option>
        <option value="aventura">üèÑ Aventura/Extremos</option>
        <option value="tradicional">üèüÔ∏è Tradicionales</option>
    </select>
    <select id="sel-sub" onchange="fetchData()"></select>
</div>

<div class="container" id="content"></div>

<div id="cine">
    <div style="padding:10px; background:#111; display:flex; justify-content:space-between; color:white; align-items:center;">
        <button onclick="closeCine()" style="background:#ef4444; border:none; color:white; padding:8px 15px; cursor:pointer; border-radius:4px; font-weight:bold;">SALIR</button>
        <span id="playing-name" style="font-size:12px;"></span>
    </div>
    <iframe id="player" allowfullscreen></iframe>
</div>

<script>
    const PROXY = "https://api.allorigins.win/get?url=";
    const API_TV = "https://api.cdn-live.tv/api/v1/events/sports/?user=cdnlivetv&plan=free";
    
    // MAPEO TOTAL DE CATEGOR√çAS SOLICITADAS
    const MUNDO = {
        acuaticos: [ {id:'swimming', n:'Nataci√≥n'}, {id:'artistic-swimming', n:'Nataci√≥n Art√≠stica'}, {id:'diving', n:'Clavados'}, {id:'water-polo', n:'Waterpolo'} ],
        atletismo: [ {id:'athletics', n:'Carreras/Saltos/Lanzamientos'}, {id:'marathon', n:'Fondo/Marat√≥n'} ],
        gimnasia: [ {id:'gymnastics', n:'Art√≠stica'}, {id:'rhythmic-gymnastics', n:'R√≠tmica'} ],
        ciclismo: [ {id:'cycling', n:'Ruta'}, {id:'cycling-track', n:'Pista'}, {id:'bmx', n:'BMX'}, {id:'mountain-biking', n:'Monta√±a'} ],
        equipo: [ {id:'soccer', n:'F√∫tbol'}, {id:'basketball', n:'Baloncesto'}, {id:'volleyball', n:'Voleibol'}, {id:'handball', n:'Balonmano'}, {id:'rugby', n:'Rugby'} ],
        combate: [ {id:'boxing', n:'Boxeo'}, {id:'judo', n:'Judo'}, {id:'wrestling', n:'Lucha'}, {id:'taekwondo', n:'Taekwondo'}, {id:'fencing', n:'Esgrima'} ],
        raqueta: [ {id:'tennis', n:'Tenis'}, {id:'badminton', n:'B√°dminton'}, {id:'table-tennis', n:'Tenis de Mesa'}, {id:'padel', n:'P√°del'} ],
        motor: [ {id:'f1', n:'F√≥rmula 1'}, {id:'motogp', n:'MotoGP'}, {id:'rally', n:'Rally/Dakar'} ],
        invierno: [ {id:'skiing', n:'Esqu√≠/Snowboard'}, {id:'curling', n:'Curling'}, {id:'ice-hockey', n:'Hockey Hielo'} ],
        precision: [ {id:'archery', n:'Tiro con Arco'}, {id:'golf', n:'Golf'}, {id:'shooting', n:'Tiro Deportivo'} ],
        aventura: [ {id:'climbing', n:'Escalada'}, {id:'surfing', n:'Surf'}, {id:'skateboarding', n:'Skate'}, {id:'triathlon', n:'Triatl√≥n'} ],
        tradicional: [ {id:'pelota-vasca', n:'Pelota Vasca'}, {id:'rural', n:'Herri Kirolak'} ]
    };

    let allChannels = [];

    async function init() {
        document.getElementById('fecha-local').innerText = new Date().toLocaleDateString('es-ES', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
        try {
            const res = await fetch(PROXY + encodeURIComponent(API_TV));
            const data = await res.json();
            const json = JSON.parse(data.contents)['cdn-live-tv'];
            Object.values(json).forEach(cat => { if(Array.isArray(cat)) allChannels.push(...cat); });
        } catch(e) { console.error("Error TV"); }
        actualizarSubCategorias();
    }

    function showView(view, btn) {
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        if(view === 'canales') {
            document.getElementById('event-controls').style.display = 'none';
            renderSoloCanales();
        } else {
            document.getElementById('event-controls').style.display = 'flex';
            fetchData();
        }
    }

    function actualizarSubCategorias() {
        const cat = document.getElementById('sel-cat').value;
        const sub = MUNDO[cat];
        document.getElementById('sel-sub').innerHTML = sub.map(s => `<option value="${s.id}">${s.n}</option>`).join('');
        fetchData();
    }

    async function fetchData() {
        const subId = document.getElementById('sel-sub').value;
        const container = document.getElementById('content');
        container.innerHTML = "<p style='text-align:center;'>Sincronizando eventos mundiales de hoy...</p>";

        try {
            // Buscamos en el endpoint general de ESPN. Si no hay datos, mostramos mensaje.
            const hoy = new Date().toISOString().split('T')[0].replace(/-/g, '');
            const res = await fetch(`https://site.api.espn.com/apis/site/v2/sports/soccer/all/scoreboard?dates=${hoy}`); // Ejemplo general
            const data = await res.json();
            
            // Filtro din√°mico: Aqu√≠ simulamos la carga de m√∫ltiples deportes
            // Nota: En una app real, cada subId llamar√≠a a su endpoint espec√≠fico de ESPN
            let html = `<h3>${document.getElementById('sel-sub').selectedOptions[0].text} - Hoy</h3>`;
            
            // Simulaci√≥n de eventos para categor√≠as minoritarias si la API principal no responde
            const eventosMock = data.events || [];

            if(eventosMock.length === 0) {
                html += `<div style="padding:40px; text-align:center; background:var(--bg-card); border-radius:10px;">
                    <p>No hay competiciones oficiales de <b>${subId}</b> detectadas para hoy.</p>
                    <p style="font-size:12px; opacity:0.6;">Consulta la secci√≥n "CANALES" para buscar emisiones tem√°ticas.</p>
                </div>`;
            }

            eventosMock.forEach(ev => {
                const comp = ev.competitions[0];
                const isLive = ev.status.type.state === 'in';
                
                // L√≥gica de b√∫squeda de canales por nombre de equipo o deporte
                let options = `<option value="">üì∫ ELEGIR SE√ëAL...</option>`;
                const query = ev.name.toLowerCase();
                
                allChannels.forEach(c => {
                    if(query.includes(c.homeTeam.toLowerCase()) || query.includes(subId)) {
                        c.channels.forEach(ch => {
                            options += `<option value="${ch.url}">${ch.channel_name}</option>`;
                        });
                    }
                });

                html += `
                <div class="match-card">
                    <div>
                        <span class="cat-tag">${subId.toUpperCase()}</span>
                        <div class="status ${isLive ? 'live-pulse' : ''}">${isLive ? 'üî¥ EN VIVO' : ev.status.type.shortDetail}</div>
                    </div>
                    <div class="teams">
                        <div><img src="${comp.competitors[0].team.logo || ''}"><br>${comp.competitors[0].team.shortDisplayName}</div>
                        <div style="font-size:18px;">${comp.competitors[0].score}-${comp.competitors[1].score}</div>
                        <div><img src="${comp.competitors[1].team.logo || ''}"><br>${comp.competitors[1].team.shortDisplayName}</div>
                    </div>
                    <div>
                        <select class="channel-selector" onchange="if(this.value) openCine(this.value, '${ev.name}')">
                            ${options}
                            <option value="https://www.rtve.es/directo/teledeporte/">üì∫ Teledeporte (Generalista)</option>
                        </select>
                    </div>
                </div>`;
            });
            container.innerHTML = html;
        } catch(e) { container.innerHTML = "Error de conexi√≥n con la central deportiva."; }
    }

    function renderSoloCanales() {
        const container = document.getElementById('content');
        const map = new Map();
        const unique = [];
        allChannels.forEach(item => {
            if(item.channels) {
                item.channels.forEach(ch => {
                    if(!map.has(ch.channel_name)) {
                        map.set(ch.channel_name, true);
                        unique.push(ch);
                    }
                });
            }
        });

        let html = `<div style="display:grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap:10px;">`;
        unique.forEach(c => {
            html += `<div style="background:var(--bg-card); padding:15px; text-align:center; border-radius:10px; cursor:pointer;" onclick="openCine('${c.url}', '${c.channel_name}')">
                <div style="font-size:24px;">üì∫</div>
                <div style="font-size:10px; font-weight:bold; margin-top:5px;">${c.channel_name}</div>
            </div>`;
        });
        html += `</div>`;
        container.innerHTML = "<h3>PARRILLA TELEVISIVA COMPLETA</h3>" + html;
    }

    function openCine(url, name) {
        document.getElementById('player').src = url;
        document.getElementById('playing-name').innerText = "Viendo: " + name;
        document.getElementById('cine').style.display = 'flex';
    }
    function closeCine() { document.getElementById('cine').style.display = 'none'; document.getElementById('player').src = ''; }

    init();
</script>
</body>
</html>
