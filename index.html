<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sports & TV Live</title>
    <link rel="manifest" href="manifest.json">
    <style>
        :root { --primary: #e50914; --bg: #0f0f0f; --card: #1b1b1b; --text: #eee; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding-bottom: 70px; }
        header { background: #000; padding: 15px; text-align: center; position: sticky; top: 0; z-index: 100; border-bottom: 2px solid var(--primary); }
        .container { padding: 15px; max-width: 800px; margin: auto; }
        .hidden { display: none; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px; }
        .card { background: var(--card); border-radius: 8px; overflow: hidden; transition: 0.3s; border: 1px solid #333; display: flex; flex-direction: column; }
        .card img { width: 100%; height: 100px; object-fit: contain; background: #222; padding: 5px; }
        .card-info { padding: 10px; font-size: 14px; text-align: center; }
        .event-row { background: var(--card); margin-bottom: 10px; padding: 12px; border-radius: 8px; display: flex; align-items: center; gap: 10px; border-left: 4px solid var(--primary); }
        .event-row img { width: 40px; height: 40px; object-fit: contain; }
        .btn-play { background: var(--primary); color: white; text-decoration: none; padding: 8px 12px; border-radius: 4px; font-size: 12px; font-weight: bold; display: inline-block; margin-top: 5px; }
        .tab-bar { position: fixed; bottom: 0; width: 100%; background: #000; display: flex; justify-content: space-around; padding: 12px 0; border-top: 1px solid #333; z-index: 1000; }
        .tab-btn { color: #888; background: none; border: none; font-size: 14px; cursor: pointer; outline: none; }
        .tab-btn.active { color: var(--primary); font-weight: bold; }
        h3 { border-bottom: 1px solid #333; padding-bottom: 5px; margin-top: 25px; color: var(--primary); text-transform: uppercase; font-size: 16px; }
    </style>
</head>
<body>

<header>
    <h2 id="view-title">ðŸ“… Agenda Deportiva</h2>
</header>

<div class="container">
    <div id="section-agenda">
        <div id="agenda-list">Cargando eventos...</div>
    </div>

    <div id="section-tv" class="hidden">
        <div class="grid" id="tv-grid">Cargando canales...</div>
    </div>
</div>

<nav class="tab-bar">
    <button class="tab-btn active" onclick="showTab('agenda')">ðŸ“… Agenda</button>
    <button class="tab-btn" onclick="showTab('tv')">ðŸ“º Canales TV</button>
</nav>

<script>
// Usamos un proxy para evitar bloqueos de seguridad (CORS)
const PROXY = "https://api.allorigins.win/raw?url=";
const API_CHANNELS = PROXY + encodeURIComponent("https://cdn-live.tv/api/v1/channels");
const API_EVENTS = PROXY + encodeURIComponent("https://cdn-live.tv/api/events");

function showTab(tab) {
    const isAgenda = tab === 'agenda';
    document.getElementById('section-agenda').classList.toggle('hidden', !isAgenda);
    document.getElementById('section-tv').classList.toggle('hidden', isAgenda);
    document.getElementById('view-title').innerText = isAgenda ? "ðŸ“… Agenda Deportiva" : "ðŸ“º Canales en Directo";
    
    document.querySelectorAll('.tab-btn').forEach(b => {
        const isTarget = (isAgenda && b.innerText.includes('Agenda')) || (!isAgenda && b.innerText.includes('Canales'));
        b.classList.toggle('active', isTarget);
    });
}

async function loadChannels() {
    try {
        // Forzamos que no use cachÃ© para evitar el error del Service Worker
        const res = await fetch(API_CHANNELS, { cache: "no-store" });
        const data = await res.json();
        const grid = document.getElementById('tv-grid');
        
        if (!data.channels) throw new Error("Datos invÃ¡lidos");

        grid.innerHTML = data.channels.map(ch => `
            <div class="card">
                <img src="${ch.image}" onerror="this.src='https://via.placeholder.com/150?text=TV'">
                <div class="card-info">
                    <strong>${ch.name}</strong><br>
                    <small>${ch.code.toUpperCase()}</small><br>
                    <a href="vlc://${ch.url}" class="btn-play">â–¶ ABRIR VLC</a>
                </div>
            </div>
        `).join('');
    } catch (e) {
        console.error("Error canales:", e);
        document.getElementById('tv-grid').innerHTML = "<p style='text-align:center'>Error al cargar canales. Intenta refrescar.</p>";
    }
}

async function loadEvents() {
    try {
        const res = await fetch(API_EVENTS, { cache: "no-store" });
        const data = await res.json();
        const list = document.getElementById('agenda-list');
        
        const sportsData = data["cdn-live-tv"];
        if (!sportsData) {
            list.innerHTML = "No hay eventos disponibles ahora.";
            return;
        }

        let html = "";
        const categorias = ["Soccer", "NBA", "NFL", "NHL"];
        
        categorias.forEach(sport => {
            if (sportsData[sport] && sportsData[sport].length > 0) {
                html += `<h3>${sport}</h3>`;
                sportsData[sport].forEach(ev => {
                    const canalUrl = ev.channels && ev.channels[0] ? ev.channels[0].url : "#";
                    const canalNombre = ev.channels && ev.channels[0] ? ev.channels[0].channel_name : "En directo";
                    
                    html += `
                        <div class="event-row">
                            <img src="${ev.homeTeamIMG}" onerror="this.src='https://via.placeholder.com/40?text=Sport'">
                            <div style="flex-grow:1">
                                <strong>${ev.homeTeam} vs ${ev.awayTeam}</strong><br>
                                <small>${ev.time} Â· ${ev.tournament}</small>
                            </div>
                            <a href="${canalUrl}" target="_blank" class="btn-play">${canalNombre}</a>
                        </div>
                    `;
                });
            }
        });
        
        list.innerHTML = html || "No hay eventos en vivo en este momento.";
    } catch (e) {
        console.error("Error eventos:", e);
        document.getElementById('agenda-list').innerHTML = "<p>Error al cargar la agenda.</p>";
    }
}

// Iniciar carga de datos
loadChannels();
loadEvents();

// Intentamos registrar el service worker solo si el archivo existe y no estÃ¡ vacÃ­o
if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('./service-worker.js').catch(() => {
        console.log("Service worker desactivado intencionalmente.");
    });
}
</script>

</body>
</html>
